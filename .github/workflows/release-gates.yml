name: Release Gates

on:
  push:
    paths: ["ai/outputs/release-gates.json", ".github/workflows/release-gates.yml"]
  pull_request:
    branches: [ main ]
    paths: ["ai/outputs/release-gates.json"]
  workflow_dispatch:

jobs:
  gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Show context and file presence
        run: |
          echo "Ref        : $GITHUB_REF"
          echo "SHA        : $GITHUB_SHA"
          echo "Actor      : $GITHUB_ACTOR"
          echo "Event name : $GITHUB_EVENT_NAME"
          ls -lah ai || true
          ls -lah ai/outputs || true
          test -f ai/outputs/release-gates.json && echo "✅ file found" || (echo "❌ file missing"; exit 1)
          echo "----- release-gates.json -----"
          cat ai/outputs/release-gates.json || true
          echo "--------------------------------"

      - name: Validate gates (CJS, with clear errors)
        run: |
          node <<'NODE'
          const fs = require('fs');
          const p = 'ai/outputs/release-gates.json';
          try{
            if(!fs.existsSync(p)){ 
              console.error('❌ Not found:', p); 
              process.exit(1);
            }
            const txt = fs.readFileSync(p,'utf8');
            let j;
            try { j = JSON.parse(txt); }
            catch(e){ 
              console.error('❌ JSON parse error:', e.message); 
              process.exit(2);
            }

            const need = ['dataQuality','tests','slo','signoff','flagStrategy'];
            let ok = true;
            for(const k of need){
              if(!(k in j)){ console.error('❌ missing key:', k); ok = false; }
            }
            if(!ok) process.exit(3);

            const boolKeys = ['dataQuality','tests','slo','signoff'];
            for(const k of boolKeys){
              if(j[k] !== true){
                console.error(`❌ gate "${k}" is not true =>`, j[k]);
                ok = false;
              }
            }
            if(!j.flagStrategy || typeof j.flagStrategy !== 'string'){
              console.error('❌ flagStrategy must be a non-empty string');
              ok = false;
            }

            if(!ok) process.exit(4);
            console.log('✅ Release gates passed:', j);
          } catch(e){
            console.error('❌ Unexpected error:', e);
            process.exit(5);
          }
          NODE
