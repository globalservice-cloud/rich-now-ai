name: AI Flow - Validate Schemas

on:
  push:
    branches: [ main ]
    paths:
      - "ai/outputs/**"
      - "ai/schemas/**"
      - ".github/workflows/ai-flow-validate.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "ai/outputs/**"
      - "ai/schemas/**"
      - ".github/workflows/ai-flow-validate.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install validator deps
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm i ajv@8 ajv-formats@2 --no-audit --no-fund

      - name: Validate JSON outputs against schemas
        run: |
          node --input-type=module - <<'NODE'
          import fs from 'fs';
          import path from 'path';
          import Ajv from 'ajv';
          import addFormats from 'ajv-formats';

          const OUT = 'ai/outputs';
          const SCHEMA = 'ai/schemas';
          const exists = p => fs.existsSync(p);
          const list = dir => (exists(dir) ? fs.readdirSync(dir) : []).filter(f => f.endsWith('.json'));

          const ajv = new Ajv({ allErrors: true, strict: false });
          addFormats(ajv);

          const files = list(OUT);
          if (files.length === 0) {
            console.log('ğŸŸ¡ ai/outputs/ ç©ºï¼Œç›´æ¥è¦–ç‚ºé€šé'); process.exit(0);
          }

          let failed = false;
          for (const f of files) {
            const dataPath = path.join(OUT, f);
            const schemaPath = path.join(SCHEMA, f.replace(/\.json$/, '.schema.json'));

            if (!exists(schemaPath)) { console.log(`âš ï¸ ç„¡å°æ‡‰ schemaï¼š${schemaPath}ï¼ˆç•¥éï¼‰`); continue; }

            const data = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
            const schema = JSON.parse(fs.readFileSync(schemaPath, 'utf8'));
            const validate = ajv.compile(schema);
            const ok = validate(data);

            if (ok) console.log(`âœ… ${f} passed`);
            else {
              failed = true;
              console.error(`âŒ ${f} failed`);
              for (const e of validate.errors) console.error(`  - ${(e.instancePath||'/')}: ${e.message}`);
              console.log(`::error file=${dataPath}::Schema validation failed against ${schemaPath}`);
            }
          }
          process.exit(failed ? 1 : 0);
          NODE
